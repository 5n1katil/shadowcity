<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shadow City — Player</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="brand__title">SHADOW CITY — PLAYER</div>
        <div class="brand__subtitle">Telefondan bağlan</div>
      </div>
      <a class="pill" href="./index.html">↩</a>
    </header>

    <main class="card stack" id="joinCard">
      <h2 class="h2">Odaya Katıl</h2>
      <div class="row">
        <div>
          <label>Oda Kodu</label>
          <input id="roomCode" placeholder="ABC123" autocomplete="off" />
        </div>
        <div>
          <label>İsmin</label>
          <input id="playerName" placeholder="Çisem" autocomplete="off" />
        </div>
      </div>
      <button class="btn btn-primary" id="btnJoin">KATIL</button>
      <div class="tiny muted" id="joinHint">Host’tan oda kodunu al.</div>
    </main>

    <main class="card stack" id="gameCard" style="display:none;">
      <div class="row">
        <div class="pill">Oda: <strong id="roomPill">—</strong></div>
        <div class="pill">Durum: <strong id="phasePill">—</strong></div>
      </div>

      <div class="notice">
        <div class="muted tiny">Rolün</div>
        <div class="big" id="roleText">—</div>
        <div class="muted" id="roleHelp">Rol dağıtılmasını bekle.</div>
        <div class="hr"></div>
        <div class="tiny muted">Gizli Mesaj</div>
        <div id="inboxText">—</div>
      </div>

      <div class="stack" id="actionArea" style="display:none;">
        <h2 class="h2" id="actionTitle">Aksiyon</h2>
        <div>
          <label>Hedef</label>
          <select id="targetSelect"></select>
          <div class="tiny muted" id="selfProtectHint" style="display:none;">
            Doktor kendini sadece sınırlı sayıda koruyabilir.
          </div>
        </div>
        <button class="btn btn-primary" id="btnSubmitAction">GÖNDER</button>
        <div class="tiny muted" id="actionHint">Host’un yönergelerini takip et.</div>
      </div>

      <div class="stack" id="voteArea" style="display:none;">
        <h2 class="h2">Oylama</h2>

        <div id="voteOnlyCallBox" class="notice" style="display:none;">
          <div class="muted">Tartışma devam ediyor. İstersen oylama başlat veya herkesin uyumasını iste.</div>
          <div class="hr"></div>
          <div class="row">
            <button class="btn btn-ghost" id="btnCallVoteStart">OYLAMA BAŞLAT</button>
            <button class="btn btn-ghost" id="btnCallFastNight">UYUYALIM</button>
          </div>
          <div class="tiny muted">Çoğunluk isterse otomatik gerçekleşir.</div>
        </div>

        <div id="voteCastBox" style="display:none;">
          <div>
            <label>Oyuncu seç (istersen SKIP)</label>
            <select id="voteSelect"></select>
          </div>
          <button class="btn btn-primary" id="btnSubmitVote">OY VER</button>
        </div>
      </div>

      <div class="notice" id="publicTextBox">
        <strong>Host:</strong>
        <div class="muted" id="publicText">—</div>
      </div>
    </main>
  </div>

  <script type="module">
    import {
      ensureAuth,
      joinRoomAsPlayer,
      playersRef,
      playerRef,
      stateRef,
      settingsRef,
      myRoleRef,
      listen,
      set,
      update,
      get,
      ref,
      db
    } from "./firebase.js";

    import { ROLES, ROLE_LABEL_TR, ACTIONS } from "./shared.js";

    let roomCode = null;
    let myUid = null;

    let players = {};
    let state = {};
    let settings = {};
    let myRoleObj = null;

    const el = (id) => document.getElementById(id);

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function myPlayer(){
      return players?.[myUid] || null;
    }

    function alivePlayersList(){
      return Object.entries(players || {})
        .filter(([uid, p]) => p && !p.isHost && p.alive)
        .map(([uid, p]) => ({ uid, name: p.name || "Oyuncu" }));
    }

    function renderTargets(selectEl, { includeSelf=false, includeNoKill=false } = {}){
      const me = myUid;
      const alive = alivePlayersList();

      const opts = [];

      if (includeNoKill) {
        opts.push({ uid: ACTIONS.NO_KILL, name: "KİMSEYİ ÖLDÜRME" });
      }

      for (const p of alive) {
        if (!includeSelf && p.uid === me) continue;
        if (p.uid === me && includeSelf) {
          opts.push({ uid: p.uid, name: `${p.name} (Sen)` });
        } else {
          opts.push({ uid: p.uid, name: p.name });
        }
      }

      selectEl.innerHTML = opts
        .map(o => `<option value="${o.uid}">${escapeHtml(o.name)}</option>`)
        .join("");
    }

    function renderVoteSelect(){
      const alive = alivePlayersList();
      const options = [
        `<option value="${ACTIONS.SKIP_VOTE}">SKIP (Kimse)</option>`,
        ...alive.map(p => `<option value="${p.uid}">${escapeHtml(p.name)}</option>`)
      ];
      el("voteSelect").innerHTML = options.join("");
    }

    function show(elm, yes){
      elm.style.display = yes ? "block" : "none";
    }

    function updateUI(){
      el("roomPill").textContent = roomCode || "—";
      el("phasePill").textContent = state?.phase || "—";
      el("publicText").textContent = state?.hostText || "—";

      const role = myRoleObj?.role || null;
      el("roleText").textContent = role ? (ROLE_LABEL_TR[role] || role) : "—";
      el("inboxText").textContent = myRoleObj?.inbox?.msg || "—";

      const me = myPlayer();
      if (!me) return;

      // default hide
      show(el("actionArea"), false);
      show(el("voteArea"), false);
      show(el("voteOnlyCallBox"), false);
      show(el("voteCastBox"), false);

      // dead => no actions
      if (!me.alive) {
        el("roleHelp").textContent = "Elendin. Oyunu izleyebilirsin.";
        return;
      }

      const phase = state?.phase;

      // WAITING / DISCUSSION: vote is optional -> show call vote only
      if (phase === "waiting" || phase === "discussion") {
        show(el("voteArea"), true);
        show(el("voteOnlyCallBox"), true);
        el("btnCallVoteStart").disabled = false;
        el("btnCallFastNight").disabled = false;
        el("roleHelp").textContent = "Tartışma zamanı. Oylama zorunlu değil.";
        return;
      }

      // VOTING: show casting UI
      if (phase === "voting") {
        show(el("voteArea"), true);
        show(el("voteCastBox"), true);
        renderVoteSelect();
        el("btnSubmitVote").disabled = false;
        el("roleHelp").textContent = "Oylama zamanı. Oyunu gönder.";
        return;
      }

      // ENDED
      if (phase === "ended") {
        el("roleHelp").textContent = "Oyun bitti.";
        return;
      }

      // NIGHT
      if (phase === "night") {
        const stage = state?.nightStage || "kill"; // host set etmeyi unutursa fallback
        const actionArea = el("actionArea");
        show(actionArea, true);

        const btn = el("btnSubmitAction");
        btn.disabled = false;

        el("selfProtectHint").style.display = "none";

        if (!role) {
          el("roleHelp").textContent = "Rol dağıtılmadı. Bekle.";
          btn.disabled = true;
          el("actionHint").textContent = "Bekle…";
          return;
        }

        // KILL stage
        if (stage === "kill") {
          el("actionTitle").textContent = "Kurban Seç";
          if (role !== ROLES.KILLER) {
            btn.disabled = true;
            el("roleHelp").textContent = "Uyuyorsun…";
            el("actionHint").textContent = "Uyuyorsun…";
          } else {
            const allowNoKill = settings?.allowNoKill === true;
            renderTargets(el("targetSelect"), { includeSelf:false, includeNoKill: allowNoKill });
            el("roleHelp").textContent = "Host katilleri uyandırınca seçim yap.";
            el("actionHint").textContent = allowNoKill
              ? "İstersen kimseyi öldürmeyebilirsin."
              : "Kimse görmüyor. Seç ve gönder.";
          }
          return;
        }

        // PROTECT stage
        if (stage === "protect") {
          el("actionTitle").textContent = "Koruma Seç";
          if (role !== ROLES.DOCTOR) {
            btn.disabled = true;
            el("roleHelp").textContent = "Uyuyorsun…";
            el("actionHint").textContent = "Uyuyorsun…";
          } else {
            const used = Number(me.doctorSelfProtectUsed || 0);
            const max = Number(settings?.doctorSelfSaveMax ?? 1);
            const canSelf = used < max;

            el("selfProtectHint").style.display = "block";
            el("selfProtectHint").textContent = `Doktor kendini ${max} kez koruyabilir. (Kullandın: ${used}/${max})`;

            renderTargets(el("targetSelect"), { includeSelf: canSelf, includeNoKill:false });

            el("roleHelp").textContent = "Doktorsan birini koru.";
            el("actionHint").textContent = canSelf
              ? "İstersen kendini de koruyabilirsin."
              : "Kendini koruma hakkını kullandın.";
          }
          return;
        }

        // INVESTIGATE stage
        if (stage === "investigate") {
          el("actionTitle").textContent = "Sorgula";
          if (role !== ROLES.DETECTIVE) {
            btn.disabled = true;
            el("roleHelp").textContent = "Uyuyorsun…";
            el("actionHint").textContent = "Uyuyorsun…";
          } else {
            renderTargets(el("targetSelect"), { includeSelf:false, includeNoKill:false });
            el("roleHelp").textContent = "Dedektifsen birini sorgula.";
            el("actionHint").textContent = "Seç ve gönder. Sonuç gizli mesaj olarak gelir.";
          }
          return;
        }

        // unknown stage
        btn.disabled = true;
        el("roleHelp").textContent = "Bekle…";
        el("actionHint").textContent = "Host aşamayı ayarlıyor…";
      }
    }

    async function join(){
      roomCode = el("roomCode").value.trim().toUpperCase();
      const name = el("playerName").value.trim();

      if (!roomCode || roomCode.length < 4) {
        el("joinHint").textContent = "Geçerli bir oda kodu gir.";
        return;
      }
      if (!name) {
        el("joinHint").textContent = "İsim gir.";
        return;
      }

      const auth = await ensureAuth();
      myUid = auth.uid;

      await joinRoomAsPlayer(roomCode, name);

      el("joinCard").style.display = "none";
      el("gameCard").style.display = "block";

      listen(playersRef(roomCode), (val) => { players = val || {}; updateUI(); });
      listen(stateRef(roomCode), (st) => { state = st || {}; updateUI(); });
      listen(settingsRef(roomCode), (s) => { settings = s || {}; updateUI(); });
      listen(myRoleRef(roomCode, myUid), (r) => { myRoleObj = r || null; updateUI(); });

      updateUI();
    }

    async function submitNightAction(){
      const me = myPlayer();
      if (!me || !me.alive) return;

      const role = myRoleObj?.role;
      const phase = state?.phase;
      const stage = state?.nightStage || "kill";
      const targetUid = el("targetSelect").value;

      if (phase !== "night") return;
      if (!role || !targetUid) return;

      // Sadece ilgili rol o aşamada yazsın (UI zaten kilitli ama güvenlik)
      if (stage === "kill" && role !== ROLES.KILLER) return;
      if (stage === "protect" && role !== ROLES.DOCTOR) return;
      if (stage === "investigate" && role !== ROLES.DETECTIVE) return;

      // doctor self-save limit client side guard (asıl doğrulama host tarafında)
      if (stage === "protect" && role === ROLES.DOCTOR && targetUid === myUid) {
        const used = Number(me.doctorSelfProtectUsed || 0);
        const max = Number(settings?.doctorSelfSaveMax ?? 1);
        if (used >= max) {
          el("actionHint").textContent = "Kendini koruma hakkın kalmadı.";
          return;
        }
      }

      const r = ref(db, `rooms/${roomCode}/night/actions/${stage}/${myUid}`);
      await set(r, targetUid);

      el("actionHint").textContent = "Gönderildi. Bekle…";
      el("btnSubmitAction").disabled = true;
    }

    async function submitVote(){
      const me = myPlayer();
      if (!me || !me.alive) return;

      if (state?.phase !== "voting") return;

      const choice = el("voteSelect").value;
      const r = ref(db, `rooms/${roomCode}/voting/votes/${myUid}`);
      await set(r, choice);

      el("btnSubmitVote").disabled = true;
    }

    async function callVoteStart(){
      const me = myPlayer();
      if (!me || !me.alive) return;

      // waiting/discussion sırasında istek gönder
      if (state?.phase !== "waiting" && state?.phase !== "discussion") return;

      const r = ref(db, `rooms/${roomCode}/requests/voteStart/${myUid}`);
      await set(r, true);

      el("btnCallVoteStart").disabled = true;
    }

    async function callFastNight(){
      const me = myPlayer();
      if (!me || !me.alive) return;

      if (state?.phase !== "waiting" && state?.phase !== "discussion") return;

      const r = ref(db, `rooms/${roomCode}/requests/fastNight/${myUid}`);
      await set(r, true);

      el("btnCallFastNight").disabled = true;
    }

    el("btnJoin").addEventListener("click", join);
    el("btnSubmitAction").addEventListener("click", submitNightAction);
    el("btnSubmitVote").addEventListener("click", submitVote);
    el("btnCallVoteStart").addEventListener("click", callVoteStart);
    el("btnCallFastNight").addEventListener("click", callFastNight);

    ensureAuth();
  </script>
</body>
</html>
