<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shadow City — Player</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:#0b0d14;color:#e9ecff}
    .wrap{max-width:520px;margin:0 auto;padding:16px}
    .card{background:#12172a;border:1px solid #2a3358;border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #33406b;background:#192041;color:#e9ecff;cursor:pointer}
    .btn.primary{background:#2a57ff;border-color:#2a57ff}
    .btn.ghost{background:#0e1324}
    .pill{padding:8px 10px;border:1px solid #2a3358;border-radius:999px;background:#0e1324}
    .muted{opacity:.75}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3358;background:#0e1324;color:#e9ecff}
    label{font-size:12px;opacity:.8}
    .big{font-size:22px;font-weight:800}
    .overlay{
      position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;
      color:#fff;opacity:.92;text-align:center;padding:24px;z-index:20
    }
    .overlay.hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="big">PLAYER</div>
      <a class="pill" href="./index.html" style="color:#e9ecff;text-decoration:none">↩</a>
    </div>
    <div style="height:10px"></div>

    <div class="card" id="joinCard">
      <div class="row">
        <div style="flex:1">
          <label>Oda Kodu</label>
          <input id="roomCode" placeholder="ABC123" autocomplete="off"/>
        </div>
        <div style="flex:1">
          <label>İsim</label>
          <input id="playerName" placeholder="Çisem" autocomplete="off"/>
        </div>
      </div>
      <div style="height:10px"></div>
      <button class="btn primary" id="btnJoin">Katıl</button>
      <div class="muted" style="margin-top:8px" id="joinHint">Host’tan oda kodunu al.</div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row">
        <div class="pill">Oda: <strong id="roomPill">—</strong></div>
        <div class="pill">Faz: <strong id="phasePill">—</strong></div>
      </div>

      <div style="height:10px"></div>

      <div class="card" style="background:#0e1324;border-color:#2a3358">
        <div class="muted" style="font-size:12px">Rolün</div>
        <div class="big" id="roleText">—</div>
        <div class="muted" id="inboxText" style="margin-top:6px">—</div>
      </div>

      <div style="height:10px"></div>

      <div id="discussionArea">
        <button class="btn ghost" id="btnCallVote">Oylama iste</button>
        <div style="height:8px"></div>
        <button class="btn ghost" id="btnFastNight">Uyuyalım (geceye geç)</button>
        <div class="muted" style="margin-top:8px;font-size:12px">
          Bu butonlar çoğunluk olursa etkili olur.
        </div>
      </div>

      <div id="voteArea" style="display:none;">
        <div class="muted" style="font-size:12px">Oylama</div>
        <select id="voteSelect"></select>
        <div style="height:8px"></div>
        <button class="btn primary" id="btnVote">Oy ver</button>
      </div>

      <div id="actionArea" style="display:none;">
        <div class="muted" style="font-size:12px" id="actionTitle">Aksiyon</div>
        <select id="targetSelect"></select>
        <div style="height:8px"></div>
        <button class="btn primary" id="btnAction">Gönder</button>
        <div class="muted" style="margin-top:6px;font-size:12px" id="actionHint">—</div>
      </div>

      <div style="height:10px"></div>
      <div class="card" style="background:#0e1324;border-color:#2a3358">
        <div class="muted" style="font-size:12px">Host</div>
        <div id="publicText">—</div>
      </div>
    </div>
  </div>

  <div class="overlay hidden" id="sleepOverlay">
    <div>
      <div class="big">UYUYORSUN…</div>
      <div class="muted" style="margin-top:10px">Rolün uyanınca ekran açılacak.</div>
    </div>
  </div>

  <script type="module">
    import {
      ensureAuth, joinRoomAsPlayer,
      playersRef, playerRef, stateRef, settingsRef, secretRoleRef,
      requestVoteMeRef, requestFastNightMeRef,
      votingVoteMeRef,
      nightActionMeRef,
      get, set, update, listen, ref, db
    } from "./firebase.js";

    import { ROLES, ROLE_TR, ACTIONS, PHASE } from "./shared.js";

    const el = (id)=>document.getElementById(id);
    let roomCode=null, myUid=null;
    let players={}, state={}, settings={}, myRole=null;

    function escapeHtml(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }

    function myPlayer(){ return players?.[myUid] || null; }

    function buildTargets({includeSelf=false, allowNoKill=false}){
      const list = Object.entries(players||{})
        .filter(([uid,p]) => p && !p.isHost && p.alive);

      const me = myUid;
      const opts = [];

      if (allowNoKill){
        opts.push({ uid: ACTIONS.NO_KILL, name: "Kimseyi öldürme (NO KILL)" });
      }

      for (const [uid,p] of list){
        if (!includeSelf && uid === me) continue;
        opts.push({ uid, name: p.name || "Oyuncu" });
      }
      return opts;
    }

    function renderVote(){
      const alive = Object.entries(players||{})
        .filter(([,p])=>p && !p.isHost && p.alive);

      const opts = [`<option value="${ACTIONS.SKIP_VOTE}">SKIP (kimse)</option>`]
        .concat(alive.map(([uid,p])=>`<option value="${uid}">${escapeHtml(p.name||"Oyuncu")}</option>`));
      el("voteSelect").innerHTML = opts.join("");
    }

    function renderActionTargets(kind){
      const me = myPlayer();
      const role = myRole?.role;
      let includeSelf = false;
      let allowNoKill = false;

      if (kind==="protect"){
        // self protect sınırı: UI tarafında “kullanıldıysa çıkar”
        const used = Number(me?.doctorSelfProtectUsed||0);
        includeSelf = used < Number(settings?.doctorSelfSaveMax ?? 1);
      }
      if (kind==="kill"){
        allowNoKill = !!settings?.allowNoKill;
      }

      const opts = buildTargets({includeSelf, allowNoKill});
      el("targetSelect").innerHTML = opts.map(o=>`<option value="${o.uid}">${escapeHtml(o.name)}</option>`).join("");
    }

    function setOverlaySleeping(on){
      el("sleepOverlay").classList.toggle("hidden", !on);
    }

    function updateUI(){
      el("roomPill").textContent = roomCode || "—";
      el("phasePill").textContent = state?.phase || "—";
      el("publicText").textContent = state?.hostText || "—";

      const role = myRole?.role || null;
      el("roleText").textContent = role ? (ROLE_TR[role] || role) : "—";
      el("inboxText").textContent = myRole?.inbox?.msg || "—";

      const me = myPlayer();
      if (!me){ return; }
      if (!me.alive){
        // öldüyse sadece izler
        el("discussionArea").style.display="none";
        el("voteArea").style.display="none";
        el("actionArea").style.display="none";
        setOverlaySleeping(false);
        return;
      }

      // default
      el("discussionArea").style.display="none";
      el("voteArea").style.display="none";
      el("actionArea").style.display="none";

      // phases
      if (state?.phase === PHASE.WAITING){
        el("discussionArea").style.display="block";
        setOverlaySleeping(false);
        return;
      }

      if (state?.phase === PHASE.DISCUSSION){
        el("discussionArea").style.display="block";
        renderVote(); // seçim listesi hazır dursun
        setOverlaySleeping(false);
        return;
      }

      if (state?.phase === PHASE.VOTING){
        el("voteArea").style.display="block";
        renderVote();
        setOverlaySleeping(false);
        return;
      }

      // Night: sadece awakeRole == benim rolüm ise aç
      if (String(state?.phase||"").startsWith("night")){
        const awake = state?.awakeRole;
        if (awake && role === awake){
          setOverlaySleeping(false);
          el("actionArea").style.display="block";

          if (state.phase === PHASE.NIGHT_KILL){
            el("actionTitle").textContent="Kurban seç";
            el("actionHint").textContent="Seçimini gönder.";
            renderActionTargets("kill");
          } else if (state.phase === PHASE.NIGHT_DOCTOR){
            el("actionTitle").textContent="Birini koru";
            el("actionHint").textContent="Kendini sadece sınırlı kez koruyabilirsin.";
            renderActionTargets("protect");
          } else if (state.phase === PHASE.NIGHT_DETECTIVE){
            el("actionTitle").textContent="Sorgula";
            el("actionHint").textContent="Sonuç gizli mesaj olarak gelir.";
            renderActionTargets("investigate");
          }
        } else {
          // uyuyor
          setOverlaySleeping(true);
        }
        return;
      }

      if (state?.phase === PHASE.MORNING){
        setOverlaySleeping(false);
        el("discussionArea").style.display="none";
        el("voteArea").style.display="none";
        el("actionArea").style.display="none";
        return;
      }

      if (state?.phase === PHASE.ENDED){
        setOverlaySleeping(false);
        el("discussionArea").style.display="none";
        el("voteArea").style.display="none";
        el("actionArea").style.display="none";
        return;
      }
    }

    async function join(){
      roomCode = el("roomCode").value.trim().toUpperCase();
      const name = el("playerName").value.trim();

      if (!roomCode || roomCode.length < 4){
        el("joinHint").textContent = "Geçerli oda kodu gir.";
        return;
      }
      if (!name){
        el("joinHint").textContent = "İsim gir.";
        return;
      }

      const me = await ensureAuth();
      myUid = me.uid;

      await joinRoomAsPlayer(roomCode, name);

      el("joinCard").style.display="none";
      el("gameCard").style.display="block";

      listen(playersRef(roomCode), (v)=>{ players=v||{}; updateUI(); });
      listen(stateRef(roomCode), (v)=>{ state=v||{}; updateUI(); });
      listen(settingsRef(roomCode), (v)=>{ settings=v||{}; updateUI(); });
      listen(secretRoleRef(roomCode, myUid), (v)=>{ myRole=v||null; updateUI(); });

      updateUI();
    }

    async function callVote(){
      const me = myPlayer();
      if (!me || !me.alive) return;
      await set(requestVoteMeRef(roomCode, myUid), true);
      el("btnCallVote").disabled = true;
      setTimeout(()=> el("btnCallVote").disabled=false, 5000);
    }

    async function fastNight(){
      const me = myPlayer();
      if (!me || !me.alive) return;
      await set(requestFastNightMeRef(roomCode, myUid), true);
      el("btnFastNight").disabled = true;
      setTimeout(()=> el("btnFastNight").disabled=false, 5000);
    }

    async function vote(){
      const me = myPlayer();
      if (!me || !me.alive) return;
      const choice = el("voteSelect").value;
      await set(votingVoteMeRef(roomCode, myUid), choice);
      el("btnVote").disabled = true;
      setTimeout(()=> el("btnVote").disabled=false, 3000);
    }

    async function action(){
      const me = myPlayer();
      if (!me || !me.alive) return;

      const role = myRole?.role;
      const target = el("targetSelect").value;

      let kind=null;
      if (state.phase === PHASE.NIGHT_KILL) kind="kill";
      if (state.phase === PHASE.NIGHT_DOCTOR) kind="protect";
      if (state.phase === PHASE.NIGHT_DETECTIVE) kind="investigate";
      if (!kind) return;

      await set(nightActionMeRef(roomCode, kind, myUid), target);
      el("btnAction").disabled = true;
      setTimeout(()=> el("btnAction").disabled=false, 3000);
    }

    el("btnJoin").addEventListener("click", join);
    el("btnCallVote").addEventListener("click", callVote);
    el("btnFastNight").addEventListener("click", fastNight);
    el("btnVote").addEventListener("click", vote);
    el("btnAction").addEventListener("click", action);

    ensureAuth();
  </script>
</body>
</html>
