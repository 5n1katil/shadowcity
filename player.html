<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Shadow City — Oyuncu</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>

  <div class="centerScreen" id="joinScreen">
    <div class="wrap">
      <div class="bigTitle">PLAYER</div>
      <div class="sub">Oda kodu + isim</div>

      <div style="height:14px"></div>

      <div class="card" style="padding:18px">
        <div class="row">
          <div class="col">
            <div class="label">Oda Kodu</div>
            <input id="roomCode" placeholder="ABC123" autocomplete="off"/>
          </div>
          <div class="col">
            <div class="label">İsim</div>
            <input id="playerName" placeholder="İsminizi Giriniz" autocomplete="off"/>
          </div>
        </div>

        <div style="height:12px"></div>
        <button class="btn primary" id="btnJoin">KATIL</button>
        <div class="sub" id="joinHint" style="margin-top:10px">Host’tan oda kodunu al.</div>

        <div style="height:12px"></div>
        <a class="pill" href="./index.html">↩</a>
      </div>
    </div>
  </div>

  <div class="centerScreen hidden" id="gameScreen">
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Oda: <b id="roomPill">—</b></div>
        <div class="pill">Faz: <b id="phasePill">—</b></div>
      </div>

      <div style="height:14px"></div>

      <div class="card" style="padding:18px">
        <div class="label">ROLÜN</div>
        <div class="bigTitle" id="roleText">—</div>
        <div class="sub" id="inboxText" style="margin-top:8px">—</div>
      </div>

      <div style="height:14px"></div>

      <div class="card" style="padding:18px" id="discussionArea">
        <div class="label">TARTIŞMA</div>
        <div class="sub" style="margin-top:8px">İstersen çoğunlukla oylama başlatabilir veya geceye geçebilirsiniz.</div>

        <div style="height:10px"></div>
        <button class="btn" id="btnRequestVote">OYLAMA BAŞLAT</button>
        <div class="sub muted hidden" style="margin-top:6px" id="voteCallStatus">—</div>
        <div style="height:8px"></div>
        <button class="btn" id="btnRequestNight">UYUYALIM</button>
        <div class="sub muted hidden" style="margin-top:6px" id="fastNightStatus">—</div>

        <div class="sub" style="margin-top:10px" id="reqHint">—</div>
      </div>

      <div class="card hidden" style="padding:18px" id="voteArea">
        <div class="label">OYLAMA</div>
        <div style="height:10px"></div>
        <select id="voteSelect"></select>
        <div style="height:10px"></div>
        <button class="btn primary" id="btnVote">OY VER</button>
        <div class="sub" style="margin-top:10px" id="voteFeedback">Henüz oy vermediniz.</div>
        <div class="sub muted" style="margin-top:6px" id="voteLiveStatus">Oy veren: —</div>
        <div class="sub muted" style="margin-top:4px" id="voteLiveList">Oy verenler: —</div>
      </div>

      <div class="card hidden" style="padding:18px" id="actionArea">
        <div class="label" id="actionTitle">AKSİYON</div>
        <div style="height:10px"></div>
        <select id="targetSelect"></select>
        <div style="height:10px"></div>
        <button class="btn primary" id="btnAction">GÖNDER</button>
        <div class="sub" style="margin-top:10px" id="actionHint">—</div>
      </div>

      <div style="height:14px"></div>

      <div class="card" style="padding:18px">
        <div class="label">HOST</div>
        <div class="sub" id="publicText" style="margin-top:6px">—</div>
      </div>
    </div>
  </div>

  <!-- Sleep overlay -->
  <div class="overlay hidden" id="sleepOverlay">
    <div>
      <div class="bigTitle">UYUYORSUN…</div>
      <div class="sub" style="margin-top:10px">Sıra sende olunca ekran açılacak.</div>
    </div>
  </div>

<script type="module">
  import {
    ensureAuth, joinRoomAsPlayer,
    playersRef, stateRef, settingsRef, playerRef,
    secretRoleRef,
    requestVoteStartMeRef, requestFastNightMeRef,
    requestVoteStartRef, requestFastNightRef,
    votingVoteMeRef, votingVotesRef,
    nightActionMeRef,
    listen, get, set, update
  } from "./firebase.js";

  import { PHASE, ROLES, ROLE_TR, ACTIONS, mergeSettings, aliveUids, strictMajority } from "./shared.js";

  const el = (id)=>document.getElementById(id);

  let roomCode=null, myUid=null;
  let players={}, state={}, settings={}, myRole=null;
  let voteRequests={}, fastNightRequests={}, votes={};
  let lastPhase=null;

  const DEFAULT_VOTE_LABEL = "OYLAMA BAŞLAT";
  const DEFAULT_NIGHT_LABEL = "UYUYALIM";
  const DEFAULT_VOTE_BUTTON_LABEL = "OY VER";

  function escapeHtml(s){
    return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function myPlayer(){ return players?.[myUid] || null; }

  function setSleep(on){ el("sleepOverlay").classList.toggle("hidden", !on); }

  function show(elm, on){ elm.classList.toggle("hidden", !on); }

  function buildTargets({includeSelf=false}){
    const alive = Object.entries(players||{})
      .filter(([uid,p])=>p && !p.isHost && p.alive);

    const opts = [];
    for (const [uid,p] of alive) {
      if (!includeSelf && uid === myUid) continue;
      opts.push({ uid, name: p.name || "Oyuncu" });
    }
    return opts;
  }

  function renderVoteSelect(){
    const alive = Object.entries(players||{})
      .filter(([,p])=>p && !p.isHost && p.alive);

    const html = [`<option value="${ACTIONS.SKIP_VOTE}">SKIP (kimse)</option>`]
      .concat(alive.map(([uid,p])=>`<option value="${uid}">${escapeHtml(p.name||"Oyuncu")}</option>`))
      .join("");
    el("voteSelect").innerHTML = html;
  }

  function renderActionTargets(kind){
    const me = myPlayer();
    const s = mergeSettings(settings);

    let includeSelf=false;

    if (kind==="protect") {
      const used = Number(me?.doctorSelfProtectUsed||0);
      includeSelf = used < Number(s.doctorSelfSaveMax||0);
    }

    const opts = buildTargets({includeSelf});
    el("targetSelect").innerHTML = opts.map(o=>`<option value="${o.uid}">${escapeHtml(o.name)}</option>`).join("");
  }

  function alivePlayerUids(){
    return aliveUids(players || {});
  }

  function majority(n){
    if (typeof strictMajority === "function") return strictMajority(n);
    return Math.floor((n || 0) / 2) + 1;
  }

  function countAliveRequests(requests){
    const aliveList = alivePlayerUids();
    const aliveSet = new Set(aliveList);

    let count = 0;
    for (const [uid, val] of Object.entries(requests || {})) {
      if (val && aliveSet.has(uid)) count++;
    }

    return { count, total: aliveList.length, majority: majority(aliveList.length || 0) };
  }

  function renderRequestStatuses(){
    const vote = countAliveRequests(voteRequests);
    const fast = countAliveRequests(fastNightRequests);
    const voteEl = el("voteCallStatus");
    const nightEl = el("fastNightStatus");
    if (voteEl) {
      voteEl.textContent = `${vote.count}/${vote.total} (Çoğunluk oylamaya katılınca oylama başlar, gereken oyuncu sayısı:${vote.majority})`;
    }
    if (nightEl) {
      nightEl.textContent = `${fast.count}/${fast.total} (Çoğunluk geceye geçmek isterse başlar, gereken oyuncu sayısı:${fast.majority})`;
    }
  }

  function renderVoteLiveStatus(){
    const statusEl = el("voteLiveStatus");
    const listEl = el("voteLiveList");
    const aliveList = alivePlayerUids();
    const aliveSet = new Set(aliveList);

    let count = 0;
    const names = [];

    for (const [uid, target] of Object.entries(votes || {})) {
      if (!target) continue;
      if (!aliveSet.has(uid)) continue;
      count++;
      const name = players?.[uid]?.name;
      if (name) names.push(name);
    }

    if (statusEl) statusEl.textContent = `Oy veren: ${count}/${aliveList.length}`;
    if (listEl) listEl.textContent = names.length ? `Oy verenler: ${names.join(", ")}` : "Oy verenler: —";
  }

  function updateUI(){
    el("roomPill").textContent = roomCode || "—";
    el("phasePill").textContent = state?.phase || "—";
    el("publicText").textContent = state?.hostText || "—";

    const role = myRole?.role || null;
    el("roleText").textContent = role ? (ROLE_TR[role] || role) : "—";
    el("inboxText").textContent = myRole?.inbox?.msg || "—";

    const me = myPlayer();
    if (!me) return;

    const discussionArea = el("discussionArea");
    const voteArea = el("voteArea");
    const actionArea = el("actionArea");
    const btnCallVote = el("btnRequestVote");
    const btnFastNight = el("btnRequestNight");
    const voteCallStatus = el("voteCallStatus");
    const fastNightStatus = el("fastNightStatus");

    const voteRequested = !!voteRequests?.[myUid];
    const fastRequested = !!fastNightRequests?.[myUid];

    renderRequestStatuses();

    // dead
    if (!me.alive) {
      show(el("discussionArea"), false);
      show(el("voteArea"), false);
      show(el("actionArea"), false);
      setSleep(false);
      el("reqHint").textContent = "Elendin. Oyunu izleyebilirsin.";
      return;
    }

    // default
    discussionArea.style.display = "";
    voteArea.style.display = "";
    actionArea.style.display = "";
    show(discussionArea, false);
    show(voteArea, false);
    show(actionArea, false);
    show(voteCallStatus, false);
    show(fastNightStatus, false);
    setSleep(false);

    if (state?.phase === PHASE.WAITING) {
      discussionArea.style.display = "none";
      voteArea.style.display = "none";
      actionArea.style.display = "none";
      setSleep(false);
      btnCallVote.disabled = true;
      if (btnFastNight) btnFastNight.disabled = true;
      show(voteCallStatus, false);
      show(fastNightStatus, false);
      el("reqHint").textContent = "Host oyunu başlatınca rolün gelir.";
      lastPhase = state?.phase || null;
      return;
    }

    if (state?.phase === PHASE.DISCUSSION) {
      btnCallVote.textContent = voteRequested ? "Katıldın ✓" : DEFAULT_VOTE_LABEL;
      btnCallVote.disabled = voteRequested;
      if (btnFastNight) {
        btnFastNight.textContent = fastRequested ? "Katıldın ✓" : DEFAULT_NIGHT_LABEL;
        btnFastNight.disabled = fastRequested;
      }
      show(discussionArea, true);
      show(voteCallStatus, true);
      show(fastNightStatus, true);
      renderRequestStatuses();
      renderVoteSelect();
      el("reqHint").textContent = "Çoğunluk olunca faz otomatik değişir.";
      lastPhase = state?.phase || null;
      return;
    }

    if (state?.phase === PHASE.VOTING) {
      if (lastPhase === PHASE.DISCUSSION) {
        btnCallVote.textContent = DEFAULT_VOTE_LABEL;
        btnCallVote.disabled = false;
        if (btnFastNight) {
          btnFastNight.textContent = DEFAULT_NIGHT_LABEL;
          btnFastNight.disabled = false;
        }
        const feedbackEl = el("voteFeedback");
        if (feedbackEl) feedbackEl.textContent = "Henüz oy vermediniz.";
      }
      show(voteCallStatus, false);
      show(fastNightStatus, false);
      show(el("voteArea"), true);
      renderVoteSelect();
      renderVoteLiveStatus();
      lastPhase = state?.phase || null;
      return;
    }

    // night: sadece awakeRole = benim rolümse aç
    if ([PHASE.NIGHT_KILL, PHASE.NIGHT_DOCTOR, PHASE.NIGHT_DETECTIVE].includes(state?.phase)) {
      if (lastPhase === PHASE.DISCUSSION) {
        btnCallVote.textContent = DEFAULT_VOTE_LABEL;
        btnCallVote.disabled = false;
        if (btnFastNight) {
          btnFastNight.textContent = DEFAULT_NIGHT_LABEL;
          btnFastNight.disabled = false;
        }
      }
      show(voteCallStatus, false);
      show(fastNightStatus, false);
      const awake = state?.awakeRole;
      if (awake && role === awake) {
        show(el("actionArea"), true);
        setSleep(false);

        if (state.phase === PHASE.NIGHT_KILL) {
          el("actionTitle").textContent = "KATİL — KURBAN SEÇ";
          el("actionHint").textContent = "Seçimini gönder.";
          renderActionTargets("kill");
        } else if (state.phase === PHASE.NIGHT_DOCTOR) {
          el("actionTitle").textContent = "DOKTOR — KORU";
          el("actionHint").textContent = "Kendini sınırlı kez koruyabilirsin.";
          renderActionTargets("protect");
        } else {
          el("actionTitle").textContent = "DEDEKTİF — SORGULA";
          el("actionHint").textContent = "Sonuç gizli mesaj olarak gelir.";
          renderActionTargets("investigate");
        }
      } else {
        setSleep(true);
      }
      lastPhase = state?.phase || null;
      return;
    }

    if (state?.phase === PHASE.MORNING) {
      show(el("discussionArea"), false);
      show(el("voteArea"), false);
      show(el("actionArea"), false);
      setSleep(false);
      lastPhase = state?.phase || null;
      return;
    }

    if (state?.phase === PHASE.ENDED) {
      setSleep(false);
      lastPhase = state?.phase || null;
      return;
    }

    lastPhase = state?.phase || null;
  }

  async function join(){
    roomCode = el("roomCode").value.trim().toUpperCase();
    const name = el("playerName").value.trim();

    if (!roomCode || roomCode.length < 4) {
      el("joinHint").textContent = "Geçerli bir oda kodu gir.";
      return;
    }
    if (!name) {
      el("joinHint").textContent = "İsim gir.";
      return;
    }

    const u = await ensureAuth();
    myUid = u.uid;

    await joinRoomAsPlayer(roomCode, name);

    show(el("joinScreen"), false);
    show(el("gameScreen"), true);

    voteRequests = {};
    fastNightRequests = {};
    votes = {};

    listen(playersRef(roomCode), (v)=>{ players=v||{}; updateUI(); });
    listen(stateRef(roomCode), (v)=>{ state=v||{}; updateUI(); });
    listen(settingsRef(roomCode), (v)=>{ settings=v||{}; updateUI(); });
    listen(secretRoleRef(roomCode, myUid), (v)=>{ myRole=v||null; updateUI(); });
    listen(requestVoteStartRef(roomCode), (v)=>{ voteRequests=v||{}; updateUI(); });
    listen(requestFastNightRef(roomCode), (v)=>{ fastNightRequests=v||{}; updateUI(); });
    listen(votingVotesRef(roomCode), (v)=>{ votes=v||{}; renderVoteLiveStatus(); });

    updateUI();
  }

  async function reqVote(){
    const me = myPlayer();
    if (!me || !me.alive) return;
    const btn = el("btnRequestVote");

    btn.disabled = true;
    btn.textContent = "Katıldın ✓";
    voteRequests = { ...(voteRequests || {}), [myUid]: true };
    renderRequestStatuses();
    await set(requestVoteStartMeRef(roomCode, myUid), true);
  }

  async function reqNight(){
    const me = myPlayer();
    if (!me || !me.alive) return;
    const btn = el("btnRequestNight");

    btn.disabled = true;
    btn.textContent = "Katıldın ✓";
    fastNightRequests = { ...(fastNightRequests || {}), [myUid]: true };
    renderRequestStatuses();
    await set(requestFastNightMeRef(roomCode, myUid), true);
  }

  async function vote(){
    const me = myPlayer();
    if (!me || !me.alive) return;
    const btn = el("btnVote");
    const select = el("voteSelect");
    if (!btn || !select) return;

    const choice = select.value;
    btn.disabled = true;
    btn.textContent = "Gönderiliyor…";
    try {
      await set(votingVoteMeRef(roomCode, myUid), choice);
      const name = choice === ACTIONS.SKIP_VOTE ? "SKIP" : (players?.[choice]?.name || "Bilinmiyor");
      const feedback = el("voteFeedback");
      if (feedback) {
        feedback.innerHTML = `Oyunuzu verdiniz.<br/>Oyunuzu: ${escapeHtml(name)}`;
      }
      btn.textContent = "Gönderildi ✅";
    } catch (e) {
      btn.textContent = "Tekrar dener misin?";
    } finally {
      setTimeout(()=>{
        const b = el("btnVote");
        if (b) {
          b.textContent = DEFAULT_VOTE_BUTTON_LABEL;
          b.disabled = false;
        }
      }, 1200);
    }
  }

  async function action(){
    const me = myPlayer();
    if (!me || !me.alive) return;

    const role = myRole?.role;
    if (!role) return;

    let kind=null;
    if (state.phase === PHASE.NIGHT_KILL) kind="kill";
    if (state.phase === PHASE.NIGHT_DOCTOR) kind="protect";
    if (state.phase === PHASE.NIGHT_DETECTIVE) kind="investigate";
    if (!kind) return;

    await set(nightActionMeRef(roomCode, kind, myUid), el("targetSelect").value);
    el("actionHint").textContent = "Gönderildi. Bekle…";
  }
  el("btnJoin").addEventListener("click", join);
  el("btnRequestVote").addEventListener("click", reqVote);
  el("btnRequestNight").addEventListener("click", reqNight);
  el("btnVote").addEventListener("click", vote);
  el("btnAction").addEventListener("click", action);

  ensureAuth();
</script>

</body>
</html>
